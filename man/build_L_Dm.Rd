% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/ccc_repeated.R
\name{build_L_Dm}
\alias{build_L_Dm}
\title{Build per-time method contrast matrix L and time-weighting D}
\usage{
build_L_Dm(df_sub, fml_sub, rmet, rtime, Dmat_global, has_interaction)
}
\arguments{
\item{df_sub}{A \code{data.frame} subset corresponding to the data being
analyzed (e.g., overall or a pair of methods). \code{df_sub[[rmet]]} and
\code{df_sub[[rtime]]} must already be factors with the intended levels
(use \code{droplevels()} upstream as needed).}

\item{fml_sub}{A right-hand-side formula (e.g. \code{~ 1 + rmet + rtime}
or \code{~ 1 + rmet + rtime + rmet:rtime}) that matches the fixed-effects
part of the model passed to 'C++'.}

\item{rmet}{Character scalar. Column name of the method factor in
\code{df_sub} (or \code{NULL} if no method factor).}

\item{rtime}{Character scalar. Column name of the time factor in
\code{df_sub} (or \code{NULL} if no time factor).}

\item{Dmat_global}{Optional numeric matrix of size \eqn{n_t \times n_t}
(where \eqn{n_t} is the number of time levels in the \emph{original} data)
providing time weights for \eqn{S_B}. If \code{NULL}, the identity is used.
When working on a subset, this function subsets \code{Dmat_global} to the
time levels present in \code{df_sub}.}

\item{has_interaction}{Logical. Whether the fixed-effects design includes the
\code{rmet:rtime} interaction term. This determines the form of the method
contrasts when \eqn{nm = 2}: with interaction, \eqn{\Delta(t_j) =
\beta_{\text{met2}} + \beta_{\text{met2:time}_j}}; without interaction,
\eqn{\Delta(t_j) = \beta_{\text{met2}}} for all \eqn{j}.}
}
\value{
A list with components:
\itemize{
\item \code{L}: numeric matrix of contrasts, dimension
\eqn{p \times q}, where \eqn{q = nt} if \eqn{nm = 2} and
\eqn{q = nd \cdot \max(nt,1)} otherwise.
\item \code{Dm}: numeric time-weighting matrix of size \eqn{q \times q}.
\item \code{nm}: effective number of method levels used (\eqn{\geq 0}).
\item \code{nt}: effective number of time levels used (\eqn{\geq 0}).
}
}
\description{
Helper that constructs the contrast matrix \code{L} (aligned to the columns
of the \emph{actual} design matrix produced by
\code{model.matrix(fml_sub, df_sub)}) and the time-weighting matrix
\code{Dm} used to compute the fixed-effect dispersion term \eqn{S_B} in the
CCC. For the common case of exactly two methods (\eqn{nm = 2}), \code{L} is
built directly from column names, guaranteeing perfect alignment and
avoiding grid/contrast mismatches. For \eqn{nm \geq 3},
a grid-based construction is used but re-ordered to match the real design.
}
\details{
Let \eqn{X = \texttt{model.matrix}(fml\_sub, df\_sub)} with \eqn{p} columns.
This function returns:

\itemize{
\item \strong{Two-method fast path} (\eqn{nm = 2}):
\itemize{
\item If there is no time factor (\eqn{nt = 0}), \code{L} is a
\eqn{p \times 1} matrix that picks the \code{met2} column in \eqn{X}
(i.e., the treatment-coded difference
\eqn{\beta_{\text{met2}} = \mu_2 - \mu_1}).
\item If \eqn{nt \geq 1}, \code{L} is \eqn{p \times nt} with columns
representing the method difference at each time level. With
interaction, column \eqn{j} encodes \eqn{\beta_{\text{met2}} +
        \beta_{\text{met2:time}_j}} for \eqn{j > 1} and
\eqn{\beta_{\text{met2}}} for the baseline;
without interaction, all columns equal \eqn{\beta_{\text{met2}}}.
\item \code{Dm} is the time-weighting matrix of size \eqn{nt \times nt}
(\code{diag(nt)} if \code{Dmat_global} is \code{NULL}).
}
\item \strong{General path} (\eqn{nm \geq 3}) represents
a method-time grid, where pairwise method differences are encoded
within each time level, yielding \code{L} of size
\eqn{p \times (nd \cdot \max(nt,1))}, with
\eqn{nd = nm(nm - 1)/2}. The grid design matrix is
column-reordered to match the actual \eqn{X} columns (critical to keep
\eqn{S_B} correct). \code{Dm} is \eqn{\mathrm{kronecker}(D, I_{nd})}
with \code{D} the time-weighting matrix.
}

All constructions are based on the \emph{actual} column names of \eqn{X}
to ensure \code{L} aligns perfectly with the design passed to the 'C++' core.
This makes the \eqn{S_B} term numerically stable, especially in small or
unbalanced designs.
}
\section{Errors and checks}{

\itemize{
\item If the required method or interaction columns cannot be found in
\code{colnames(model.matrix(fml_sub, df_sub))}, an error is thrown.
\item If \code{Dmat_global} is supplied but its dimension does not match
the total number of time levels in the original data, an error is
thrown.
}
}

\seealso{
\code{\link{ccc_lmm_reml}} for the high-level wrapper that calls
this helper, and the 'C++' core that consumes \code{L}/\code{Dm}.
}
\author{
Thiago de Paula Oliveira
}
\keyword{internal}
